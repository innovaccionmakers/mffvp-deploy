# azure-pipelines-ci.yml

trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

variables:
  DOTNET_VERSION: '8.0.x'

stages:
- stage: BuildAndTest
  displayName: 'CI – Build & Test'
  jobs:
  - job: Build
    displayName: 'Restore · Build · Test'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      - checkout: self

      - task: UseDotNet@2
        displayName: 'Setup .NET $(DOTNET_VERSION)'
        inputs:
          packageType: 'sdk'
          version: '$(DOTNET_VERSION)'

      - script: dotnet restore MFFVP.sln
        displayName: 'dotnet restore'

      - script: dotnet build MFFVP.sln --no-restore --configuration Release
        displayName: 'dotnet build (Release)'

      - script: dotnet test MFFVP.sln --no-build --configuration Release
        displayName: 'dotnet test (Release)'
      
      - script: npm install -g railway
        displayName: 'Install Railway CLI'

      - script: |
          railway login --token $(cf62cfa2-2444-46c5-b39b-cd9e4cbfc2f6)
          railway up --service f1699a06-9b8b-4b52-9027-c2f936d43e20
        displayName: 'Deploy to Railway'

      # Publicamos los artefactos del build para CD
      - task: PublishPipelineArtifact@1
        displayName: 'Publish build artifact'
        inputs:
          targetPath: '$(Pipeline.Workspace)'
          artifact: 'MFFVP_Build'